'''
MIT License

Copyright (c) 2024 Innoptech

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
'''

import cv2
import numpy as np
import base64
import openfdcm

def decode_image(base64_str):
    base64_data = base64.b64decode(base64_str.split(",")[1])
    image_data = np.frombuffer(base64_data, np.uint8)
    image = cv2.imdecode(image_data, cv2.IMREAD_GRAYSCALE)
    return image

def detect_lines(image):
    fld = cv2.ximgproc.createFastLineDetector()
    lines = fld.detect(image)
    return lines

def convert_lines_to_array(lines):
    num_lines = len(lines)
    line_array = np.zeros((4, num_lines))
    for i, line in enumerate(lines):
        line_array[:, i] = line[0]
    return line_array

def apply_transform(template, transform):
    num_lines = template.shape[1]
    transformed_template = np.zeros_like(template)
    for i in range(num_lines):
        point1 = np.dot(transform[:2, :2], template[:2, i]) + transform[:2, 2]
        point2 = np.dot(transform[:2, :2], template[2:, i]) + transform[:2, 2]
        transformed_template[:2, i] = point1
        transformed_template[2:, i] = point2
    return transformed_template

def draw_lines(image, lines):
    for i in range(lines.shape[1]):
        pt1 = (int(lines[0, i]), int(lines[1, i]))
        pt2 = (int(lines[2, i]), int(lines[3, i]))
        cv2.line(image, pt1, pt2, (255, 0, 0), 2)
    return image
def resize_to_same_height(images):
    max_height = max(image.shape[0] for image in images)
    resized_images = []
    for image in images:
        aspect_ratio = image.shape[1] / image.shape[0]
        new_width = int(max_height * aspect_ratio)
        resized_images.append(cv2.resize(image, (new_width, max_height)))
    return resized_images

def display_best_match(tmpl_image, template, transform):
    transformed_template = apply_transform(template, transform)
    color_scene_image = cv2.cvtColor(scene_image, cv2.COLOR_GRAY2BGR)
    result_image = draw_lines(color_scene_image.copy(), transformed_template)
    tmpl_image_color = cv2.cvtColor(tmpl_image, cv2.COLOR_GRAY2BGR)
    cv2.imshow("Template", tmpl_image_color)
    cv2.imshow("Scene", color_scene_image)
    cv2.imshow("Best Match", result_image)
    cv2.waitKey(0)
    cv2.destroyAllWindows()

# Decode images from base64
tmpl_image_base64 = "data:image/png;base64,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"
scene_image_base64 = "data:image/jpeg;base64,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"
tmpl_image = decode_image(tmpl_image_base64)
scene_image = decode_image(scene_image_base64)

# Detect lines using Fast Line Detector
tmpl_lines = detect_lines(tmpl_image)
scene_lines = detect_lines(scene_image)

# Convert lines to LineArray format
scale = 0.75
templates = [convert_lines_to_array(tmpl_lines)*scale]
scene = convert_lines_to_array(scene_lines)

# Perform template matching
max_tmpl_lines, max_scene_lines = 4, 4  # Combinatory search parameters.
depth = 30              # The [0, pi] discretization.
scene_ratio = 1.0       # The image size ratio used for FDCM algorithm. Relative to the scene lines length.
scene_padding = 1.5     # Pad the scene images used in the FDCM algorithm, use if best match may appear on image boundaries.
coeff = 5.0             # A weighting factor to enhance the angular cost vs distance cost in FDCM algorithm.
num_threads = 4

threadpool = openfdcm.ThreadPool(num_threads)
search_strategy = openfdcm.DefaultSearch(max_tmpl_lines, max_scene_lines)
optimizer_strategy = openfdcm.DefaultOptimize(threadpool)
matcher = openfdcm.DefaultMatch()

featuremap_params = openfdcm.Dt3CpuParameters(depth=depth, dt3Coeff=coeff, padding=scene_padding)
featuremap = openfdcm.build_cpu_featuremap(scene, featuremap_params, threadpool)
matches = openfdcm.search(matcher, search_strategy, optimizer_strategy, featuremap, templates, scene)

if matches:
    best_match = matches[0]
    best_match_tmpl_id = best_match.tmpl_idx
    best_match_template = templates[best_match_tmpl_id]
    result_rotation = best_match.transform[0:2, 0:2]
    result_translation = best_match.transform[0:2, 2]

    print("Result Rotation:\n", result_rotation)
    print("Result Translation:\n", result_translation)

    display_best_match(tmpl_image, best_match_template, best_match.transform)
